---
title: "TP53 HIST1H3B,H3F3A,HIST1H3C alterations in cohort"
output: html_notebook

params:
  cohort_label_file:
    label: "Cohort specific annotation file"
    value: pbta-histologies.tsv
    input: file
  telomere_ratio:
    label: "Telomere ratio file from merging control_summary.tsv and tumor_summary.tsv"
    value: telomere_940_ratio.tsv
    input: file  

---

```{r echo=FALSE,message=FALSE,warning=FALSE}
set.seed(12345)

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
setwd(root_dir)
library(data.table)
library(tidyverse)

# soft linked to v17
cohort_plot_labels <- read_tsv(file.path(root_dir,"data",params$cohort_label_file))
telomere_ratio <- read_tsv(file.path(root_dir,"data",params$telomere_ratio))

mutect2 <- fread(file.path(root_dir,"data","pbta-snv-mutect2.vep.maf.gz"),select=c("IMPACT","Hugo_Symbol","Tumor_Sample_Barcode","HGVSp_Short")) %>% unique()
strelka2 <- fread(file.path(root_dir,"data","pbta-snv-strelka2.vep.maf.gz"),select=c("IMPACT","Hugo_Symbol","Tumor_Sample_Barcode","HGVSp_Short")) %>% unique()
consensus_snv <- fread(file.path(root_dir,"data","pbta-snv-consensus-mutation.maf.tsv.gz"),select=c("IMPACT","Hugo_Symbol","Tumor_Sample_Barcode","HGVSp_Short")) %>% unique()
consensus_cnv <- read_tsv(file.path(root_dir,
                                      "data",
                                      "consensus_seg_annotated_cn_autosomes.tsv.gz")) 

```


```{r echo=FALSE,message=FALSE,warning=FALSE}
source(file.path("..","utils","get_alt.R"))

alt<-get_alt(c("ATRX"))
```


```{r echo=FALSE,message=FALSE,warning=FALSE}
format_snv_binary<-function(gene,alt_caller,caller) {
  colname<-paste0(gene,"_MOD_HIGH_mut_",caller)
  alt_caller <- alt_caller %>% 
    dplyr::select(c("Tumor_Sample_Barcode",
                    "Hugo_Symbol")) %>%
    # select only TP53
    dplyr::filter(Hugo_Symbol %in% gene ) %>% 
    # unique so that 1 = mutation exists 0 mutation doesn't exist
    unique()
  if (nrow(alt_caller)>0) {
  alt_caller <- alt_caller %>%
    # reshape to make TP53 row
    reshape2::dcast(Tumor_Sample_Barcode ~ Hugo_Symbol,fun.aggregate = length) %>%
    # rename 
    dplyr::rename(!!colname := gene )
  }
}

format_snv_hgvs<-function(gene,alt_caller,caller) {
  colname<-paste0(gene,"_MOD_HIGH_mut_",caller)
  alt_caller <- alt_caller %>%
  dplyr::select (c("Tumor_Sample_Barcode",
                    "Hugo_Symbol","HGVSp_Short")) %>%
  # select only gene 
  dplyr::filter(Hugo_Symbol== gene) %>% 
  # unique so that 1 = mutation exists 0 mutation doesn't exist
  unique() 
  if (nrow(alt_caller)>0) {
  alt_caller <- alt_caller %>%
    dplyr::group_by(Tumor_Sample_Barcode ,Hugo_Symbol) %>%
    # aggregate mutations
    summarise( !! colname := toString(HGVSp_Short))
  }
}

```


```{r}
ATRX_strelka2<- alt$strelka2 %>% format_snv_hgvs("ATRX",.,"strelka2")

ATRX_mutect2 <- alt$mutect2 %>% format_snv_hgvs("ATRX",.,"mutect2")

ATRX_consensus <- alt$consensus_snv %>% format_snv_hgvs("ATRX",.,"consensus")

ATRX_consensus_cnv <- alt$consensus_cnv %>%
  # select TP53
  dplyr::filter(gene_symbol=="ATRX")

if ( nrow(ATRX_consensus_cnv) > 0){
  ATRX_consensus_cnv <- ATRX_consensus_cnv %>%
    # reshape to make gain /loss columns
    reshape2::dcast(biospecimen_id ~ status ,value.var = "status",fun.aggregate = length) %>%
    # rename columns
    dplyr::rename("ATRX_gain_consensus_cnv"="gain","ATRX_loss_consensus_cnv"="loss")
  
  
  merge_ATRX <- full_join(ATRX_strelka2,ATRX_mutect2,by=c("Tumor_Sample_Barcode","Hugo_Symbol")) %>%
    full_join(ATRX_consensus,by=c("Tumor_Sample_Barcode","Hugo_Symbol")) %>%
    full_join(ATRX_rna_seq_snv,by=c("Tumor_Sample_Barcode","Hugo_Symbol")) %>%
    full_join(ATRX_consensus_cnv,by=c("Tumor_Sample_Barcode"="biospecimen_id")) %>%
    dplyr::filter(Tumor_Sample_Barcode %in% cohort_plot_labels$Kids_First_Biospecimen_ID)
}else {
 merge_ATRX <- full_join(ATRX_strelka2,ATRX_mutect2,by=c("Tumor_Sample_Barcode","Hugo_Symbol")) %>%
    full_join(ATRX_consensus,by=c("Tumor_Sample_Barcode","Hugo_Symbol")) %>%
    dplyr::filter(Tumor_Sample_Barcode %in% cohort_plot_labels$Kids_First_Biospecimen_ID)
   
}

telomere_ratio %>% left_join( merge_ATRX , by=c("Kids_First_Biospecimen_ID_tumor"="Tumor_Sample_Barcode"))  %>% write_tsv(file.path("..","scratch","pbta_telomere_ratio_merged_ATRX.tsv"))

```


```{r}

check_ratio<-telomere_ratio %>% left_join( merge_ATRX , by=c("Kids_First_Biospecimen_ID_tumor"="Tumor_Sample_Barcode"))

ggplot(check_ratio,aes(x=Hugo_Symbol,y=ratio))+geom_boxplot()+ggpubr::stat_compare_means()

```
```{r}
# with ATRX alt in strelka2/mutect2/consensus 
check_ratio %>% dplyr::filter(Hugo_Symbol == "ATRX") %>% pull(ratio) %>% mean()
```


```{r}
# without ATRX alt in strelka2/mutect2/consensus 
check_ratio %>% dplyr::filter(is.na(Hugo_Symbol)) %>% pull(ratio) %>% mean()
```

